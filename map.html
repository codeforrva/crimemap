<!DOCTYPE html>
<html>
  <head>
    <title>Richmond Police Incident Map</title>
    <style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAfQSRe2y5nBlY-MdBY4JtCPWw0Zfr6ZHk&amp;libraries=visualization">
    </script>
    <script type="text/javascript">

      function mapsInit() {
        // build map
        var mapOptions = {
          center: { lat: 37.5333, lng: -77.4667 },
          zoom: 12
        };
        window.map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);

        // get some points once the map is idle
        google.maps.event.addListenerOnce(window.map, 'idle', function() {
          //var ne = window.map.getBounds().getNorthEast();
          //var sw = window.map.getBounds().getSouthWest();

          //$.post("/logstash-*/logs/_search", JSON.stringify({
          $.post("http://mogrify.us.to:9203/_search", JSON.stringify({
            "query": {
              "filtered": {
                "filter": {
                  "and": [
                    // require geocoded
                    { "term": { "tags": "geocoded" } },
                    // date range - greater than now minus six months
                    { "range": { "@timestamp": { "gt": "now-6M" } } }
                  ]
                  
                  // this filter would limit points to a bounding box area
                  /* 
                  "geo_bounding_box": {
                    "geoip.location": {
                      "top_right": {
                        "lat": ne.lat(),
                        "lon": ne.lng()
                      },
                      "bottom_left": {
                        "lat": sw.lat(),
                        "lon": sw.lng()
                      }
                    }
                  }
                  */
                }
              }
            },
            "from": 0,
            "size": 500, // max number of points to get
            "_source": ["geoip", "offenseCodeDesc", "@timestamp", "dispositionCodeDesc"]
          }), function(data) {
            
            // this does a heatmap layer. more points is better. only need geoip in _source
            /*
            var points = data.hits.hits.map(function(doc) {
              return new google.maps.LatLng(
                doc._source.geoip.location.lat,
                doc._source.geoip.location.lon);
            });

            var heatmap = new google.maps.visualization.HeatmapLayer({
              data: new google.maps.MVCArray(points)
            });
            heatmap.setMap(window.map);
            */

            // this adds points as markers with info windows
            data.hits.hits.map(function(doc) {
              doc._source.timestamp = doc._source["@timestamp"];

              var marker = new google.maps.Marker({
                position: new google.maps.LatLng(
                    doc._source.geoip.location.lat,
                    doc._source.geoip.location.lon),
                map: window.map,
                title: doc._source.offenseCodeDesc
              });

              google.maps.event.addListener(marker, 'click', function() {
                if (window.infoWindow) {
                  window.infoWindow.close();
                }
                window.infoWindow = new google.maps.InfoWindow({
                  content: window.infoWindowTemplate(doc._source)
                });
                window.infoWindow.open(marker.map, marker);
              });
            });

          }, 'json');
        });
      }
      google.maps.event.addDomListener(window, 'load', mapsInit);

      google.maps.event.addDomListener(window, 'load', function() {
        Handlebars.registerHelper('date', function(context) {
          return moment(new Date(context)).format("MMMM D, YYYY [at] h:mm a");
        });
        window.infoWindowTemplate = Handlebars.compile($('#infoWindowTemplate').html());
      });


    </script>
  </head>
  <body>
  <div id="map-canvas"></div>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.0/handlebars.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
  <script id="infoWindowTemplate" type="text/x-handlebars-template">
    <h3>{{offenseCodeDesc}}</h3>
    <p>{{date timestamp}}</p>
    <p>{{dispositionCodeDesc}}</p>
  </script>
  </body>
</html>