<!DOCTYPE html>
<html>
  <head>
    <title>Richmond Police Incident Map</title>
    <style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAfQSRe2y5nBlY-MdBY4JtCPWw0Zfr6ZHk&amp;libraries=visualization">
    </script>
    <script type="text/javascript">

      function mapsInit() {
        // build map
        var mapOptions = {
          center: { lat: 37.5333, lng: -77.4667 },
          zoom: 12
        };
        window.map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);

        // get some points once the map is idle
        google.maps.event.addListenerOnce(window.map, 'idle', function() {

          $.getJSON("https://brigades.opendatanetwork.com/resource/ush7-in5v.json?$$app_token=3sg2sPslVNC65HpUxDTSfRR4d" +
              "&$limit=500" +
              "&$select=incident_location,offense_code_desc,incident_date_time,disposition_code_desc")
            .done(function(data) {

              // this does a heatmap layer. more points is better. only need incident_location in $select
              /*
              var points = data.map(function(row) {
                return new google.maps.LatLng(
                  row.incident_location.latitude,
                  row.incident_location.longitude);
              });

              var heatmap = new google.maps.visualization.HeatmapLayer({
                data: new google.maps.MVCArray(points)
              });
              heatmap.setMap(window.map);
              */

              data.map(function(row) {
                // TODO: would be better to filter these out in the query. not sure what the syntax is.
                if (!row.incident_location.latitude || !row.incident_location.longitude)
                  return;

                row.incident_address = JSON.parse(row.incident_location.human_address).address;

                var marker = new google.maps.Marker({
                  position: new google.maps.LatLng(
                      row.incident_location.latitude,
                      row.incident_location.longitude),
                  map: window.map,
                  title: row.offense_code_desc,
                  icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 6,
                    fillColor: getColorString(row.offense_code_desc),
                    fillOpacity: 0.9,
                    strokeColor: getColorString(row.offense_code_desc, true),
                    strokeOpacity: 0.6,
                    strokeWeight: 1
                  }
                });

                google.maps.event.addListener(marker, 'click', function() {
                  if (window.infoWindow) {
                    window.infoWindow.close();
                  }
                  window.infoWindow = new google.maps.InfoWindow({
                    content: window.infoWindowTemplate(row)
                  });
                  window.infoWindow.open(marker.map, marker);
                  window.console && console.log(row);
                });
              });

            })
            .fail(function(obj) {
              window.console && console.error("Request failed", obj);
            });
        });
      }
      google.maps.event.addDomListener(window, 'load', mapsInit);

      google.maps.event.addDomListener(window, 'load', function() {
        Handlebars.registerHelper('date', function(context) {
          return moment(new Date(context)).format("MMMM D, YYYY [at] h:mm a");
        });
        window.infoWindowTemplate = Handlebars.compile($('#infoWindowTemplate').html());
      });

      function getColorString(str, stroke) {
        // hash code for strings, used to generate color codes
        // http://erlycoder.com/49/javascript-hash-functions-to-convert-string-into-integer-hash-
        var hash = 5381;
        for (i = 0; i < str.length; i++) {
            char = str.charCodeAt(i);
            hash = ((hash << 5) + hash) + char; /* hash * 33 + c */
        }

        var h = hash % 360;
        var s = Math.abs((hash >> 8) % 50);
        var l = Math.abs((hash >> 4) % 50);

        return 'hsl(' + h + ', ' + (s+50) + '%, ' + (l+(stroke?0:25)) + '%)';
      }

    </script>
  </head>
  <body>
  <div id="map-canvas"></div>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.0/handlebars.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
  <script id="infoWindowTemplate" type="text/x-handlebars-template">
    <h3>{{offense_code_desc}}</h3>
    <p>{{date incident_date_time}}</p>
    <p>{{disposition_code_desc}}</p>
    <p>{{incident_address}}</p>
    <p>({{incident_location.latitude}}, {{incident_location.longitude}})</p>
  </script>
  </body>
</html>