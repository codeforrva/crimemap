<!DOCTYPE html>
<html>
  <head>
    <title>Richmond Police Incident Heatmap</title>
    <style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAfQSRe2y5nBlY-MdBY4JtCPWw0Zfr6ZHk&amp;libraries=visualization">
    </script>
    <script type="text/javascript">

      function mapsInit() {
        // build map
        var mapOptions = {
          center: { lat: 37.5333, lng: -77.4667 },
          zoom: 12
        };
        window.map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);

        // get some points once the map is idle
        google.maps.event.addListenerOnce(window.map, 'idle', function() {

          $.getJSON("https://brigades.opendatanetwork.com/resource/ush7-in5v.json?$$app_token=3sg2sPslVNC65HpUxDTSfRR4d" +
              "&$limit=50000" + // max 50000
              "&$select=incident_location")
            .done(function(data) {

              // this does a heatmap layer. more points is better. only need incident_location in $select
              var points = data.filter(function(row) {
                return (
                  // filter out rows with no coordinates
                  row.incident_location.latitude && row.incident_location.longitude &&
                  // filter out city hall
                  (row.incident_location.longitude != "-77.43364758299998" &&
                  row.incident_location.latitude != "37.54070234900007") &&
                  // filter out police HQ
                  (row.incident_location.longitude != "-77.44491629499998" &&
                  row.incident_location.latitude != "37.546095328000035") &&
                  // TODO: see if there are other police stations, courthouses, etc.
                  // the very common 1300 Coalter Street address may be the sheriff's office, not sure
                  true);
              }).map(function(row) {
                return new google.maps.LatLng(
                  row.incident_location.latitude,
                  row.incident_location.longitude);
              });

              var heatmap = new google.maps.visualization.HeatmapLayer({
                data: new google.maps.MVCArray(points)
              });
              heatmap.setMap(window.map);

            })
            .fail(function(obj) {
              window.console && console.error("Request failed", obj);
            });
        });
      }
      google.maps.event.addDomListener(window, 'load', mapsInit);

    </script>
  </head>
  <body>
  <div id="map-canvas"></div>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  </body>
</html>